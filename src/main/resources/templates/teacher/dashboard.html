<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Teacher Dashboard - Analytics & Grading</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .text-theme { color: #198754; }
        .bg-theme { background-color: #198754; color: white; }
        .btn-theme { background-color: #198754; color: white; border: none; }
        .btn-theme:hover { background-color: #157347; color: white; }
        .dashboard-card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.04); height: 100%; background: white; transition: transform 0.2s; }
        .stat-box { padding: 20px; border-radius: 10px; background: #fff; border-left: 5px solid #198754; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-value { font-size: 1.8rem; font-weight: bold; color: #212529; }
        .bar-container { height: 180px; width: 40px; background-color: #f8f9fa; border-radius: 4px; position: relative; margin: 0 auto; }
        .bar-fill { position: absolute; bottom: 0; width: 100%; border-radius: 4px; transition: height 0.5s ease; }
        .sortable-header { cursor: pointer; text-decoration: none; color: inherit; display: block; width: 100%; }
        .empty-state { color: #adb5bd; text-align: center; padding: 40px 20px; }
    </style>
</head>
<body>

<div class="d-flex" style="min-height: 100vh;">
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <div class="w-100 d-flex flex-column">
        <div th:replace="~{fragments/header :: header}"></div>

        <div class="container-fluid p-4">

            <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3 bg-white p-3 rounded shadow-sm">
                <div>
                    <h4 class="fw-bold text-theme mb-1"><i class="fas fa-chalkboard-teacher me-2"></i>Class Dashboard</h4>
                    <form id="contextForm" action="/teacher/dashboard" method="get" class="d-flex align-items-center gap-2">
                        <input type="hidden" name="keyword" th:value="${keyword}">

                        <select class="form-select form-select-sm border-success" name="classId" onchange="this.form.submit()">
                            <option value="">-- All Classes --</option>
                            <option th:each="c : ${classes}"
                                    th:value="${c.classId}"
                                    th:text="${c.className}"
                                    th:selected="${selectedClassId != null && selectedClassId == c.classId}">
                            </option>
                        </select>
                        <select class="form-select form-select-sm border-success" name="subjectId" onchange="this.form.submit()">
                            <option value="">-- All Subjects --</option>
                            <option th:each="s : ${subjects}"
                                    th:value="${s.courseId}"
                                    th:text="${s.courseName}"
                                    th:selected="${selectedSubjectId != null && selectedSubjectId == s.courseId}">
                            </option>
                        </select>
                    </form>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#inputGradeModal">
                        <i class="fas fa-plus me-2"></i>Single Input
                    </button>
                </div>
            </div>

            <div class="row g-3 mb-4" th:if="${stats != null}">
                <div class="col-md-3">
                    <div class="stat-box border-primary">
                        <div class="stat-title text-muted small">Average Score</div>
                        <div class="stat-value text-primary" th:text="${stats.averageScore}">0.0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box border-warning">
                        <div class="stat-title text-muted small">Pass Rate (>=60)</div>
                        <div class="stat-value text-warning" th:text="${stats.passRate + '%'}">0%</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box border-info">
                        <div class="stat-title text-muted small">Merit (80-89)</div>
                        <div class="stat-value text-info" th:text="${stats.excellenceRate + '%'}">0%</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box border-success">
                        <div class="stat-title text-muted small">Distinction (>90)</div>
                        <div class="stat-value text-success" th:text="${stats.distinctionRate + '%'}">0%</div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-lg-7">
                    <div class="card dashboard-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-chart-bar me-2"></i>Score Distribution</span>
                        </div>
                        <div class="card-body">
                            <div th:if="${distribution != null}" class="d-flex align-items-end justify-content-around h-100 pb-2">
                                <div th:each="item : ${distribution}" class="text-center flex-grow-1">
                                    <div class="bar-container">
                                        <div class="bar-fill"
                                             th:classappend="${item.rangeStart < 60 ? 'bg-danger' : (item.rangeStart >= 90 ? 'bg-success' : (item.rangeStart >= 80 ? 'bg-info' : 'bg-warning'))}"
                                             th:style="'height: ' + ${item.percentage} + '%'"

                                             data-bs-toggle="tooltip"
                                             data-bs-placement="top"
                                             th:title="${item.percentage + '% (' + item.count + ' students)'}">
                                        </div>
                                    </div>
                                    <small class="d-block mt-2 fw-bold text-muted" style="font-size: 0.7rem;" th:text="${item.label}">Label</small>
                                    <span class="badge bg-light text-dark border mt-1" th:text="${item.count}">0</span>
                                </div>
                            </div>
                            <div th:unless="${distribution != null}" class="empty-state"><p>No data available.</p></div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="card dashboard-card">
                        <div class="card-header p-0 pt-2 px-2 bg-white border-0">
                            <ul class="nav nav-tabs nav-fill" id="analysisTab" role="tablist">
                                <li class="nav-item">
                                    <button class="nav-link active text-success fw-bold" id="top-tab" data-bs-toggle="tab" data-bs-target="#top" type="button">Top Achievers</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link text-danger fw-bold" id="bottom-tab" data-bs-toggle="tab" data-bs-target="#bottom" type="button">Needs Attention</button>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body p-0">
                            <div class="p-2 bg-light d-flex justify-content-end align-items-center border-bottom">
                                <small class="me-2 text-muted">Show Top:</small>
                                <form action="/teacher/dashboard" method="get">
                                    <input type="hidden" name="classId" th:value="${selectedClassId}">
                                    <input type="hidden" name="subjectId" th:value="${selectedSubjectId}">
                                    <input type="hidden" name="keyword" th:value="${keyword}">
                                    <select name="limitN" class="form-select form-select-sm py-0" style="width: 70px;" onchange="this.form.submit()">
                                        <option value="5" th:selected="${limitN == 5}">5</option>
                                        <option value="10" th:selected="${limitN == 10}">10</option>
                                        <option value="20" th:selected="${limitN == 20}">20</option>
                                    </select>
                                </form>
                            </div>

                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="top" role="tabpanel">
                                    <div class="list-group list-group-flush" style="max-height: 250px; overflow-y: auto;">
                                        <div th:each="s, stat : ${topStudents}" class="list-group-item d-flex justify-content-between">
                                            <div><span class="badge bg-warning text-dark me-2">[[${stat.count}]]</span><span th:text="${s.studentName}"></span></div>
                                            <span class="fw-bold text-success" th:text="${s.score}"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="bottom" role="tabpanel">
                                    <div class="list-group list-group-flush" style="max-height: 250px; overflow-y: auto;">
                                        <div th:if="${bottomStudents != null}" th:each="s : ${bottomStudents}" class="list-group-item d-flex justify-content-between">
                                            <div><i class="fas fa-exclamation-triangle text-danger me-2"></i><span th:text="${s.studentName}"></span></div>
                                            <span class="fw-bold text-danger" th:text="${s.score}"></span>
                                        </div>
                                        <div th:if="${bottomStudents == null || bottomStudents.isEmpty()}" class="p-3 text-center text-muted">No students need attention.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card dashboard-card">
                <div class="card-header d-flex flex-wrap gap-3 justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-theme"><i class="fas fa-list me-2"></i>Grade Management</h5>

                    <div class="d-flex gap-2">
                        <input class="form-control form-control-sm" type="search" id="gradeSearchInput" placeholder="Search Student Name or ID..." style="width: 200px;" onkeyup="filterAndRenderGrades()">
                        <button class="btn btn-outline-secondary btn-sm" onclick="goToLastGradePage()" title="Go to last page">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                            <tr class="text-secondary text-uppercase small">
                                <th class="ps-4">ID</th>
                                <th>Student Name</th>
                                <th>Class</th>
                                <th>Subject</th>
                                <th>Score</th>
                                <th class="text-center">Rank</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                            </thead>
                            <tbody id="gradeTableBody">
                            </tbody>
                        </table>
                    </div>

                    <div class="p-3 border-top d-flex justify-content-between align-items-center" id="gradePaginationControls" style="display:none;">
                        <div class="page-info" id="gradePageInfo">Showing 0-0 of 0 students</div>
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary btn-sm" onclick="prevGradePage()" id="btnGradePrev">Previous</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="nextGradePage()" id="btnGradeNext">Next</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div th:replace="~{fragments/footer :: footer}"></div>
    </div>
</div>

<div class="modal fade" id="inputGradeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-theme text-white">
                <h5 class="modal-title fw-bold" id="modalTitle">Input Grade</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/teacher/grades/save" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="id" id="grade-id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label small text-muted">Class</label>
                            <select class="form-select" name="classId" id="modal-class" required>
                                <option th:each="c : ${classes}" th:value="${c.classId}" th:text="${c.className}"></option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label small text-muted">Subject</label>
                            <select class="form-select" name="subjectId" id="modal-subject" required>
                                <option th:each="s : ${subjects}" th:value="${s.courseId}" th:text="${s.courseName}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Student ID</label>
                        <input type="text" name="studentIdentifier" id="modal-student" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Score</label>
                        <input type="number" step="0.1" name="score" id="modal-score" class="form-control" min="0" max="100" required>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-theme px-4">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    // --- STATE MANAGEMENT ---
    // Extract full grade data passed from the backend (previously 'grades' variable)
    const allGradesData = [[${grades}]];
    const isAverageMode = [[${isAverageMode}]];
    let currentGrades = [];
    let gradeCurrentPage = 0; // 0-based index
    const GRADE_ITEMS_PER_PAGE = 10;

    // --- 1. INITIALIZATION ---
    window.onload = function() {
        // Initial setup for grade table
        filterAndRenderGrades();

        // 2. Initialize Bootstrap Tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    }

    // --- 2. SEARCH & FILTERING ---
    function filterAndRenderGrades() {
        const query = document.getElementById('gradeSearchInput').value.toLowerCase();

        currentGrades = allGradesData.filter(g => {
            const studentId = g.studentId ? g.studentId.toLowerCase() : '';
            const studentName = g.studentName ? g.studentName.toLowerCase() : '';

            return studentId.includes(query) || studentName.includes(query);
        });

        gradeCurrentPage = 0;
        renderGradeTable();
    }

    // --- 3. RENDERING UI ---
    function renderGradeTable() {
        const tbody = document.getElementById('gradeTableBody');
        const pagination = document.getElementById('gradePaginationControls');
        tbody.innerHTML = "";

        // CẬP NHẬT HEADER DỰA TRÊN CHẾ ĐỘ TRUNG BÌNH
        const theadHtml = isAverageMode ? `
            <tr class="text-secondary text-uppercase small">
                <th class="ps-4">ID</th>
                <th>Student Name</th>
                <th>Class</th>
                <th>Average Score</th>
                <th class="text-center">Rank</th>
                <th class="text-end pe-4">Actions</th>
            </tr>
        ` : `
            <tr class="text-secondary text-uppercase small">
                <th class="ps-4">ID</th>
                <th>Student Name</th>
                <th>Class</th>
                <th>Subject</th>
                <th>Score</th>
                <th class="text-center">Rank</th>
                <th class="text-end pe-4">Actions</th>
            </tr>
        `;
        document.querySelector('#gradeTableBody').parentElement.querySelector('thead').innerHTML = theadHtml;


        if (!currentGrades || currentGrades.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${isAverageMode ? 6 : 7}" class="text-center py-5 text-muted">No data found.</td></tr>`;
            pagination.style.display = 'none';
            return;
        }

        pagination.style.display = 'flex';
        const start = gradeCurrentPage * GRADE_ITEMS_PER_PAGE;
        const end = start + GRADE_ITEMS_PER_PAGE;
        const pageData = currentGrades.slice(start, end);

        pageData.forEach((g, index) => {
            const scoreDisplay = g.score != null ?
                `<span class="fw-bold ${g.score >= 90 ? 'text-success' : (g.score >= 80 ? 'text-info' : (g.score >= 60 ? 'text-dark' : 'text-danger'))}">${g.score}</span>` :
                `<span class="badge bg-secondary text-white-50 fst-italic">Not Graded</span>`;

            const rankDisplay = g.score != null ?
                `<span class="fw-bold text-secondary">#${g.rank}</span>` :
                `<span>-</span>`;

            const actionButtons = `
                <button ${g.score != null ? 'class="btn btn-sm btn-outline-primary"' : 'class="btn btn-sm btn-success"'}
                        data-bs-toggle="modal" data-bs-target="#inputGradeModal" onclick="prepareEdit(this)"
                        data-id="${g.id || ''}"
                        data-student="${g.studentName || ''}"
                        data-student-id="${g.studentId || ''}"
                        data-class-id="${g.classId || ''}"
                        data-subject-id="${g.courseId || ''}"
                        data-score="${g.score || ''}">
                    <i class="fas ${g.score != null ? 'fa-edit' : 'fa-plus'}"></i>
                </button>`;

            let row;

            if (isAverageMode) {
                // RENDER CHẾ ĐỘ B (AVERAGE)
                row = `
                    <tr>
                        <td class="ps-4 text-muted">${g.studentId || 'N/A'}</td>
                        <td class="fw-bold text-dark">${g.studentName || 'N/A'}</td>
                        <td><span class="badge bg-primary text-white fst-italic">${g.className || 'N/A'}</span></td>
                        <td>${scoreDisplay}</td>
                        <td class="text-center">${rankDisplay}</td>
                        <td class="text-end pe-4">${actionButtons}</td>
                    </tr>`;
            } else {
                // RENDER CHẾ ĐỘ A (SPECIFIC SUBJECT) - NHƯ CŨ
                row = `
                    <tr>
                        <td class="ps-4 text-muted">${g.studentId || 'N/A'}</td>
                        <td class="fw-bold text-dark">${g.studentName || 'N/A'}</td>
                        <td><span class="badge bg-light text-dark border">${g.className || 'N/A'}</span></td>
                        <td>${g.courseName || 'N/A'}</td>
                        <td>${scoreDisplay}</td>
                        <td class="text-center">${rankDisplay}</td>
                        <td class="text-end pe-4">${actionButtons}</td>
                    </tr>`;
            }
            tbody.insertAdjacentHTML('beforeend', row);
        });

        updateGradePaginationInfo(currentGrades.length);
    }

    // --- 4. PAGINATION CONTROLS ---

    function updateGradePaginationInfo(total) {
        const start = gradeCurrentPage * GRADE_ITEMS_PER_PAGE + 1;
        let end = (gradeCurrentPage + 1) * GRADE_ITEMS_PER_PAGE;
        if (end > total) end = total;

        document.getElementById('gradePageInfo').innerText = `Showing ${start}-${end} of ${total} students`;
        document.getElementById('btnGradePrev').disabled = (gradeCurrentPage === 0);
        document.getElementById('btnGradeNext').disabled = (end >= total);
    }

    function prevGradePage() {
        if (gradeCurrentPage > 0) {
            gradeCurrentPage--;
            renderGradeTable();
        }
    }

    function nextGradePage() {
        if (((gradeCurrentPage + 1) * GRADE_ITEMS_PER_PAGE) < currentGrades.length) {
            gradeCurrentPage++;
            renderGradeTable();
        }
    }

    function goToLastGradePage() {
        const totalItems = currentGrades.length;
        if (totalItems === 0) return;

        const lastPage = Math.ceil(totalItems / GRADE_ITEMS_PER_PAGE);
        gradeCurrentPage = lastPage - 1; // 0-based
        renderGradeTable();
    }

    // --- 5. MODAL LOGIC (Existing) ---

    function prepareEdit(button) {
        document.getElementById('modalTitle').innerText = button.getAttribute('data-score') ? 'Edit Grade' : 'Add Grade';
        document.getElementById('grade-id').value = button.getAttribute('data-id') || '';
        document.getElementById('modal-score').value = button.getAttribute('data-score') || '';
        document.getElementById('modal-student').value = button.getAttribute('data-student-id') || '';
        document.getElementById('modal-class').value = button.getAttribute('data-class-id');
        document.getElementById('modal-subject').value = button.getAttribute('data-subject-id');
    }
    document.getElementById('inputGradeModal').addEventListener('hidden.bs.modal', function () {
        document.querySelector('form').reset();
    });
</script>
</body>
</html>